# 编译 Ubuntu 根文件系统

环境：

- Ubuntu 16.04 amd64

安装依赖包：

``` shell
sudo apt-get install qemu qemu-user-static binfmt-support debootstrap
```

下载 Ubuntu core：

``` shell
wget -c http://cdimage.ubuntu.com/ubuntu-base/releases/18.04/release/ubuntu-base-18.04-base-arm64.tar.gz
```

创建一个大小为 1000M 的根文件系统映像文件，并使用 Ubuntu 的基础包去初始化：

``` shell
fallocate -l 1000M rootfs.img
sudo mkfs.ext4 -F ROOTFS rootfs.img
mkdir mnt
sudo mount rootfs.img mnt
sudo tar -xzvf ubuntu-base-18.04-base-arm64.tar.gz -C mnt/
sudo cp -a /usr/bin/qemu-aarch64-static mnt/usr/bin/
```

`qemu-aarch64-static`是其中的关键，能在 x86_64 主机系统下 chroot 到 arm64 文件系统：

Chroot 到新的文件系统中去并初始化：

``` shell
sudo chroot mnt/

# 这里可以修改设置
USER=firefly
HOST=firefly

# 创建用户
useradd -G sudo -m -s /bin/bash $USER
passwd $USER
# 输入密码

# 设置主机名和以太网
echo $HOST /etc/hostname
echo "127.0.0.1    localhost.localdomain localhost" > /etc/hosts
echo "127.0.0.1    $HOST" >> /etc/hosts
echo "auto eth0" > /etc/network/interfaces.d/eth0
echo "iface eth0 inet dhcp" >> /etc/network/interfaces.d/eth0
echo "nameserver 127.0.1.1" > /etc/resolv.conf

# 使能串口
ln -s /lib/systemd/system/serial-getty\@.service /etc/systemd/system/getty.target.wants/serial-getty@ttyS0.service

# 安装包
apt-get update
apt-get upgrade
apt-get install ifupdown net-tools network-manager
apt-get install udev sudo ssh
apt-get install vim-tiny
```

卸载文件系统：

``` shell
sudo umount rootfs/
```

Credit： [bholland](https://forum.armbian.com/topic/6850-document-about-compiling-a-kernel-and-rootfs-for-the-firefly-boards/)

## 参考

- [http://opensource.rock-chips.com/wiki_Distribution](http://opensource.rock-chips.com/wiki_Distribution)





!INCLUDE "include/map.md"
