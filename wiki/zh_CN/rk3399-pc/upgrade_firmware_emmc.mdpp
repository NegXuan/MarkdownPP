# 烧写emmc

## 前言

升级固件有两种模式分别是[RKUSB]、[Maskrom]模式。在烧写时请根据自己需要**选择合适的烧写方法**。


## 准备工作

* ROC-RK3399-PC 开发板
* 固件
* 主机
* 良好的Type-C数据线
* emmc

固件文件一般有两种：

* 单个统一固件 update.img, 将启动加载器、参数和所有分区镜像都打包到一起，用于固件发布。
* 多个分区镜像,如 kernel.img, rootfs.img, uboot.img 等，在开发阶段生成的局部镜像。
* 可以在这里找到[已编译好的统一固件](download.html)，下载后解压。也可以参考编译固件的说明自行编译。

主机操作系统支持：
> * Windows XP （32/64位）
> * Windows 7 (32/64位)
> * Windows 8 (32/64位)
> * Linux (32/64位)

<a id="USB_driver"></a>
windows需要安装RKUSB驱动

下载 [ Release_DriverAssistant.zip](https://pan.baidu.com/s/1geKZFz1#list/path=%2F) ，解压，然后运行里面的 DriverInstall.exe 。   
为了所有设备都使用更新的驱动，请先选择"驱动卸载"，然后再选择"驱动安装"。   

![](img/upgrade_firmware1.png)

## 烧写模式
<a id="RKUSB_mode"></a>

### RKUSB模式

[RKUSB]模式为一般情况下的正常升级模式，如果loader损坏不能进入[RKUSB]模式才需要强制进入[Maskrom]模式。

* 设备断开电源,并且断开所有外设
* Typec数据线一头接电脑
* 按住RECOVERY键，Typec-0口接上数据线,保持两秒以上松开RECOVERY键

**注意:ROC-RK3399-PC供电和固件升级都是Typec-0接口。通过接电脑usb供电时，由于电流过小，开发板无法带起部分外设导致启动异常，所以升级前最好先断开所有外设。**
<a id="Maskrom_mode"></a>

### Maskrom模式

通常情况下不需要进入[Maskrom]模式，只有当loader损坏才需要进入此模式。

**进入Maskrom模式涉及硬件操作，请认真阅读谨慎操作**

* 设备断开电源,并且断开所有外设
* Typec数据线一头接电脑
* 用金属镊子短接板上预留的emmc的`CLK`和`GND`焊点，Typec-0口接上数据线,保持2秒以上松开金属镊子。

![](img/roc-rk3399-pc5.jpg)

**注意：进入Maskrom模式同样最好先断开所有外设**

## Windows

如果设备成功进入升级模式主机应该会提示发现新硬件并配置驱动。打开设备管理器，会见到新设备"Rockusb Device" 出现，如下图。如果没有，则需要返回上一步重新[安装驱动]。   

![](img/androidtool1.png)

### 准备升级工具
<a id="Androidtool"></a>

下载 [AndroidTool_2.58](http://www.t-firefly.com/doc/download/page/id/53.html)解压，运行目录里面的 AndroidTool.exe(版本在2.55以上)，如下图：   

![](img/androidtool2.png)

若设备处于 RKUSB 模式，状态行将显示 “发现一个LOADER设备”。

若设备处于 Maskrom 模式，状态行将显示 “发现一个MASKROM设备”。

[Androidtool] 是针对烧写 Android[RK 固件] 而开发的工具，但是同样可以用来烧写ubuntu固件。
<a id="w_normal"></a>
### 烧写完整固件 

烧写统一固件 update.img 的步骤如下:

1. 切换至"升级固件"页。
2. 按"固件"按钮，打开要升级的固件文件。升级工具会显示详细的固件信息。
3. 按"升级"按钮开始升级。<font color=#ff0000 >(原固件为Android的情况下，升级ubuntu固件请执行第四步。)</font>
4. 如果升级失败，可以尝试先按"擦除Flash"按钮来擦除 Flash，然后再升级。

**注意：如果你烧写的固件laoder版本与原来的机器的不一致，请在升级固件前先执行"擦除Flash"。**   

![](img/upgrade_firmware3.png)

### 烧写分区映像

烧写分区映像的步骤如下：

1. 切换至"下载镜像"页。
2. 勾选需要烧录的分区，可以多选。
3. 确保映像文件的路径正确，需要的话，点路径右边的空白表格单元格来重新选择。
4. 点击"执行"按钮开始升级，升级结束后设备会自动重启。

![](img/upgrade_firmware4.png)



## Linux

成功进入升级模式主机会检测到新的usb设备

<a id="upgrade_and_rkdeveloptool"></a>
### 准备工具

* upgrade_tool:   
```
git clone -b master https://github.com/FireflyTeam/tools.git
mv tools/linux/Linux_Upgrade_Tool/Linux_Upgrade_Tool/upgrade_tool /usr/local/bin/
```

### 烧写完整固件 

<a id="lu_normal"></a>
#### Ubuntu
* 进入[Maskrom]或[RKUSB]模式、烧写[RK 固件]**(只有loder损坏才需要使用Maskrom)**
```
sudo upgrade_tool uf update.img
sudo upgrade_tool rd     # 重置并启动设备

```
<a id="luef_normal"></a>
<font color=#ff0000 >**注意**:原固件为Android的情况下,烧写ubuntu固件请执行以下操作:</font>

* 进入[Maskrom]或[RKUSB]模式、烧写[RK 固件]**(只有loder损坏才需要使用Maskrom)**
```

# 擦除flash 使用ef参数需要指定loader文件或者对应的update.img
sudo upgrade_tool ef update.img #update.img :你需要烧写的ubuntu固件
# 重新烧写
sudo upgrade_tool uf update.img 
```


<a id="la_normal"></a>
#### Android
* 进入[Maskrom]或[RKUSB]模式、烧写[RK 固件]**(只有loder损坏才需要使用Maskrom)**
```
sudo upgrade_tool uf update.img
sudo upgrade_tool rd     # 重置并启动设备
```

### 烧写分区映像

#### ubuntu
* 进入[RKUSB]模式、烧写[分区映像]**(原固件为ubuntu[RK 固件])**
```
	sudo upgrade_tool ul $LOADER
        sudo upgrade_tool di -p $PARAMETER
        sudo upgrade_tool di -uboot $UBOOT
        sudo upgrade_tool di -trust $TRUST
        sudo upgrade_tool di -b $BOOT
        sudo upgrade_tool di -r $RECOVERY
        sudo upgrade_tool di -m $MISC
        sudo upgrade_tool di -oem $OEM
        sudo upgrade_tool di -userdata $USERDATA
        sudo upgrade_tool di -rootfs $ROOTFS
```
也可以直接使用SDK的脚本烧写`./rkflash.sh`
```
	./rkflash.sh boot
	./rkflash.sh uboot
	./rkflash.sh loader
	./rkflash.sh parameter
	./rkflash.sh trust
	./rkflash.sh recovery
	./rkflash.sh misc
	./rkflash.sh oem
	./rkflash.sh userdata
	./rkflash.sh rootfs

```

<a id="partition_addr"></a>

#### Android
* 进入[RKUSB]模式、烧写[分区映像]**(原固件为Android[RK 固件])**
```
	sudo upgrade_tool di -b /path/to/boot.img
	sudo upgrade_tool di -k /path/to/kernel.img
	sudo upgrade_tool di -s /path/to/system.img
	sudo upgrade_tool di -r /path/to/recovery.img
	sudo upgrade_tool di -m /path/to/misc.img
	sudo upgrade_tool di resource /path/to/resource.img
	sudo upgrade_tool di -p parameter   # 烧写 parameter
	sudo upgrade_tool ul bootloader.bin # 烧写 bootloader
```


!INCLUDE "include/map.md"
